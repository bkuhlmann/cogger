#! /usr/bin/env ruby
# frozen_string_literal: true

require "bundler/inline"

gemfile true do
  source "https://rubygems.org"

  gem "amazing_print"
  gem "benchmark-ips"
  gem "debug"
  gem "cogger", path: ".."
  gem "dry-logger"
  gem "ougai"
  gem "tty-logger"
end

puts "INITIALIZATION\n\n"

Benchmark.ips do |benchmark|
  benchmark.config time: 5, warmup: 2

  benchmark.report("Cogger") { Cogger.new }
  benchmark.report("Dry Logger") { Dry.Logger :demo }
  benchmark.report("Ougai") { Ougai::Logger.new STDOUT }
  benchmark.report("TTY Logger") { TTY::Logger.new }

  benchmark.compare!
end

puts "DEFAULT\n\n"

Benchmark.ips do |benchmark|
  cogger = Cogger.new io: StringIO.new, formatter: :simple
  dry = Dry.Logger :demo, stream: StringIO.new
  ougai = Ougai::Logger.new StringIO.new

  tty = TTY::Logger.new output: StringIO.new do |config|
    config.handlers = [[:console, {enable_color: false}]]
  end

  message = "test"

  benchmark.config time: 5, warmup: 2

  benchmark.report("Cogger") { cogger.info message }
  benchmark.report("Dry Logger") { dry.info message }
  benchmark.report("Ougai") { ougai.info message }
  benchmark.report("TTY Logger") { tty.info message }

  benchmark.compare!
end

puts "COLOR\n\n"

Benchmark.ips do |benchmark|
  cogger = Cogger.new io: StringIO.new

  dry = Dry.Logger :demo,
                   stream: StringIO.new,
                   template: "%<severity>s %<message>s",
                   colorize: true,
                   severity_colors: {info: :green, unknown: :gray}

  ougai = Ougai::Logger.new StringIO.new
  ougai.formatter = Ougai::Formatters::Readable.new
  tty = TTY::Logger.new output: StringIO.new

  message = "test"

  benchmark.config time: 5, warmup: 2

  benchmark.report("Cogger") { cogger.info message }
  benchmark.report("Dry Logger") { dry.info message }
  benchmark.report("Ougai") { ougai.info message }
  benchmark.report("TTY Logger") { tty.info message }

  benchmark.compare!
end

puts "JSON\n\n"

Benchmark.ips do |benchmark|
  cogger = Cogger.new io: StringIO.new, formatter: :json
  dry = Dry.Logger :demo, stream: StringIO.new, formatter: :json
  ougai = Ougai::Logger.new StringIO.new
  tty = TTY::Logger.new(output: StringIO.new) { |config| config.formatter = :json }

  payload = {message: "test", one: 1, two: 2, three: 3}

  benchmark.config time: 5, warmup: 2

  benchmark.report("Cogger") { cogger.info(**payload) }
  benchmark.report("Dry Logger") { dry.info(**payload) }
  benchmark.report("Ougai") { ougai.info(**payload) }
  benchmark.report("TTY Logger") { tty.info(**payload) }

  benchmark.compare!
end

__END__

INITIALIZATION

ruby 3.4.5 (2025-07-16 revision 20cda200d3) +YJIT +PRISM [arm64-darwin24.5.0]
Warming up --------------------------------------
              Cogger    23.318k i/100ms
          Dry Logger    26.467k i/100ms
               Ougai    26.353k i/100ms
          TTY Logger    22.655k i/100ms
Calculating -------------------------------------
              Cogger    232.269k (± 2.1%) i/s    (4.31 μs/i) -      1.166M in   5.021800s
          Dry Logger    262.933k (± 1.8%) i/s    (3.80 μs/i) -      1.323M in   5.034628s
               Ougai    261.348k (± 1.1%) i/s    (3.83 μs/i) -      1.318M in   5.042321s
          TTY Logger    226.821k (± 2.0%) i/s    (4.41 μs/i) -      1.155M in   5.095857s

Comparison:
          Dry Logger:   262933.0 i/s
               Ougai:   261348.4 i/s - same-ish: difference falls within error
              Cogger:   232269.2 i/s - 1.13x  slower
          TTY Logger:   226821.2 i/s - 1.16x  slower

DEFAULT

ruby 3.4.5 (2025-07-16 revision 20cda200d3) +YJIT +PRISM [arm64-darwin24.5.0]
Warming up --------------------------------------
              Cogger    23.235k i/100ms
          Dry Logger    30.076k i/100ms
               Ougai    47.497k i/100ms
          TTY Logger    25.870k i/100ms
Calculating -------------------------------------
              Cogger    232.192k (± 1.2%) i/s    (4.31 μs/i) -      1.162M in   5.004076s
          Dry Logger    305.406k (± 1.5%) i/s    (3.27 μs/i) -      1.534M in   5.023572s
               Ougai    481.814k (± 5.3%) i/s    (2.08 μs/i) -      2.422M in   5.045612s
          TTY Logger    252.812k (± 3.4%) i/s    (3.96 μs/i) -      1.268M in   5.019971s

Comparison:
               Ougai:   481813.8 i/s
          Dry Logger:   305406.4 i/s - 1.58x  slower
          TTY Logger:   252812.1 i/s - 1.91x  slower
              Cogger:   232191.9 i/s - 2.08x  slower

COLOR

ruby 3.4.5 (2025-07-16 revision 20cda200d3) +YJIT +PRISM [arm64-darwin24.5.0]
Warming up --------------------------------------
              Cogger     7.350k i/100ms
          Dry Logger    27.647k i/100ms
               Ougai    49.510k i/100ms
          TTY Logger    18.871k i/100ms
Calculating -------------------------------------
              Cogger     72.758k (± 1.5%) i/s   (13.74 μs/i) -    367.500k in   5.052109s
          Dry Logger    271.166k (± 3.9%) i/s    (3.69 μs/i) -      1.355M in   5.005375s
               Ougai    497.746k (± 4.8%) i/s    (2.01 μs/i) -      2.525M in   5.087272s
          TTY Logger    188.063k (± 4.0%) i/s    (5.32 μs/i) -    943.550k in   5.027414s

Comparison:
               Ougai:   497746.1 i/s
          Dry Logger:   271166.4 i/s - 1.84x  slower
          TTY Logger:   188063.1 i/s - 2.65x  slower
              Cogger:    72758.2 i/s - 6.84x  slower

JSON

ruby 3.4.5 (2025-07-16 revision 20cda200d3) +YJIT +PRISM [arm64-darwin24.5.0]
Warming up --------------------------------------
              Cogger    19.223k i/100ms
          Dry Logger    24.948k i/100ms
               Ougai    32.601k i/100ms
          TTY Logger     9.408k i/100ms
Calculating -------------------------------------
              Cogger    194.467k (± 4.0%) i/s    (5.14 μs/i) -    980.373k in   5.051341s
          Dry Logger    248.817k (± 4.1%) i/s    (4.02 μs/i) -      1.247M in   5.024186s
               Ougai    332.004k (± 5.5%) i/s    (3.01 μs/i) -      1.663M in   5.027603s
          TTY Logger     92.731k (± 1.5%) i/s   (10.78 μs/i) -    470.400k in   5.073837s

Comparison:
               Ougai:   332004.2 i/s
          Dry Logger:   248817.4 i/s - 1.33x  slower
              Cogger:   194467.3 i/s - 1.71x  slower
          TTY Logger:    92731.1 i/s - 3.58x  slower
