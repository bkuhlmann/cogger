#! /usr/bin/env ruby
# frozen_string_literal: true

require "bundler/inline"

gemfile true do
  source "https://rubygems.org"

  gem "benchmark-ips"
  gem "debug"
  gem "cogger", path: ".."
  gem "dry-logger"
  gem "logging"
  gem "tty-logger"
end

puts "INITIALIZATION\n\n"

Benchmark.ips do |benchmark|
  benchmark.config time: 5, warmup: 2

  benchmark.report("Cogger") { Cogger.new }
  benchmark.report("Dry Logger") { Dry.Logger :demo }
  benchmark.report("Logging") { Logging.logger STDOUT }
  benchmark.report("TTY Logger") { TTY::Logger.new }

  benchmark.compare!
end

puts "PLAIN\n\n"

Benchmark.ips do |benchmark|
  cogger = Cogger.new io: StringIO.new, formatter: :simple
  dry = Dry.Logger :demo, stream: StringIO.new

  Logging.appenders.string_io "string_io"
  logging = Logging.logger StringIO.new
  logging.add_appenders "string_io"

  tty = TTY::Logger.new output: StringIO.new do |config|
    config.handlers = [[:console, {enable_color: false}]]
  end

  message = "test"

  benchmark.config time: 5, warmup: 2

  benchmark.report("Cogger") { cogger.info message }
  benchmark.report("Dry Logger") { dry.info message }
  benchmark.report("Logging") { logging.info message }
  benchmark.report("TTY Logger") { tty.info message }

  benchmark.compare!
end

puts "COLOR\n\n"

Benchmark.ips do |benchmark|
  cogger = Cogger.new io: StringIO.new

  dry = Dry.Logger :demo,
                   stream: StringIO.new,
                   template: "%<severity>s %<message>s",
                   colorize: true,
                   severity_colors: {info: :green, unknown: :gray}

  Logging.color_scheme "bright",
                       levels: {
                         info: :green,
                         warn: :yellow,
                         error: :red,
                         fatal: %i[white on_red]
                       },
                       date: :blue,
                       logger: :cyan,
                       message: :magenta
  Logging.appenders.string_io "string_io",
                              layout: Logging.layouts.pattern(
                                pattern: "[%d] %-5l %c: %m\n",
                                color_scheme: "bright"
                              )
  logging = Logging.logger StringIO.new
  logging.add_appenders "string_io"

  tty = TTY::Logger.new output: StringIO.new

  message = "test"

  benchmark.config time: 5, warmup: 2

  benchmark.report("Cogger") { cogger.info message }
  benchmark.report("Dry Logger") { dry.info message }
  benchmark.report("Logging") { logging.info message }
  benchmark.report("TTY Logger") { tty.info message }

  benchmark.compare!
end

puts "JSON\n\n"

Benchmark.ips do |benchmark|
  cogger = Cogger.new io: StringIO.new, formatter: :json
  dry = Dry.Logger :demo, stream: StringIO.new, formatter: :json

  Logging.appenders.stdout "string_io", layout: Logging.layouts.json
  logging = Logging.logger StringIO.new

  tty = TTY::Logger.new(output: StringIO.new) { |config| config.formatter = :json }

  payload = {one: 1, two: 2, three: 3}

  benchmark.config time: 5, warmup: 2

  benchmark.report("Cogger") { cogger.info payload }
  benchmark.report("Dry Logger") { dry.info payload }
  benchmark.report("Logging") { logging.info payload }
  benchmark.report("TTY Logger") { tty.info payload }

  benchmark.compare!
end

__END__

INITIALIZATION

Warming up --------------------------------------
              Cogger    18.525k i/100ms
          Dry Logger    18.008k i/100ms
             Logging   299.201k i/100ms
          TTY Logger    15.801k i/100ms
Calculating -------------------------------------
              Cogger    184.708k (± 2.3%) i/s -    926.250k in   5.017113s
          Dry Logger    181.453k (± 3.3%) i/s -    918.408k in   5.066156s
             Logging      3.259M (± 1.9%) i/s -     16.456M in   5.051705s
          TTY Logger    159.506k (± 1.7%) i/s -    805.851k in   5.053612s

Comparison:
             Logging:  3258621.3 i/s
              Cogger:   184707.7 i/s - 17.64x  slower
          Dry Logger:   181452.7 i/s - 17.96x  slower
          TTY Logger:   159506.3 i/s - 20.43x  slower

PLAIN

Warming up --------------------------------------
              Cogger    31.461k i/100ms
          Dry Logger    23.369k i/100ms
             Logging    37.432k i/100ms
          TTY Logger    18.772k i/100ms
Calculating -------------------------------------
              Cogger    316.756k (± 2.0%) i/s -      1.605M in   5.067212s
          Dry Logger    226.082k (± 1.8%) i/s -      1.145M in   5.066495s
             Logging    375.789k (± 5.7%) i/s -      1.872M in   4.999962s
          TTY Logger    189.744k (± 2.0%) i/s -    957.372k in   5.047505s

Comparison:
             Logging:   375789.1 i/s
              Cogger:   316756.3 i/s - 1.19x  slower
          Dry Logger:   226081.8 i/s - 1.66x  slower
          TTY Logger:   189743.6 i/s - 1.98x  slower

COLOR

Warming up --------------------------------------
              Cogger     6.471k i/100ms
          Dry Logger    21.417k i/100ms
             Logging    27.102k i/100ms
          TTY Logger    14.018k i/100ms
Calculating -------------------------------------
              Cogger     64.963k (± 1.8%) i/s -    330.021k in   5.081705s
          Dry Logger    209.475k (± 2.2%) i/s -      1.049M in   5.012140s
             Logging    271.235k (± 6.1%) i/s -      1.355M in   5.019159s
          TTY Logger    141.017k (± 2.1%) i/s -    714.918k in   5.071898s

Comparison:
             Logging:   271235.3 i/s
          Dry Logger:   209474.7 i/s - 1.29x  slower
          TTY Logger:   141017.1 i/s - 1.92x  slower
              Cogger:    64963.0 i/s - 4.18x  slower

JSON

Warming up --------------------------------------
              Cogger    16.140k i/100ms
          Dry Logger    14.941k i/100ms
             Logging    28.996k i/100ms
          TTY Logger     6.626k i/100ms
Calculating -------------------------------------
              Cogger    161.893k (± 2.9%) i/s -    823.140k in   5.088670s
          Dry Logger    150.580k (± 2.2%) i/s -    761.991k in   5.062482s
             Logging    291.470k (± 4.8%) i/s -      1.479M in   5.088168s
          TTY Logger     66.460k (± 3.1%) i/s -    337.926k in   5.088947s

Comparison:
             Logging:   291469.8 i/s
              Cogger:   161893.0 i/s - 1.80x  slower
          Dry Logger:   150580.3 i/s - 1.94x  slower
          TTY Logger:    66460.4 i/s - 4.39x  slower
