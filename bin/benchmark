#! /usr/bin/env ruby
# frozen_string_literal: true

require "bundler/inline"

gemfile true do
  source "https://rubygems.org"

  gem "amazing_print"
  gem "benchmark-ips"
  gem "debug"
  gem "cogger", path: ".."
  gem "dry-logger"
  gem "logging"
  gem "ougai"
  gem "tty-logger"
end

puts "INITIALIZATION\n\n"

Benchmark.ips do |benchmark|
  benchmark.config time: 5, warmup: 2

  benchmark.report("Cogger") { Cogger.new }
  benchmark.report("Dry Logger") { Dry.Logger :demo }
  benchmark.report("Logging") { Logging.logger STDOUT }
  benchmark.report("Ougai") { Ougai::Logger.new STDOUT }
  benchmark.report("TTY Logger") { TTY::Logger.new }

  benchmark.compare!
end

puts "DEFAULT\n\n"

Benchmark.ips do |benchmark|
  cogger = Cogger.new io: StringIO.new, formatter: :simple
  dry = Dry.Logger :demo, stream: StringIO.new

  Logging.appenders.string_io "string_io"
  logging = Logging.logger StringIO.new
  logging.add_appenders "string_io"

  ougai = Ougai::Logger.new StringIO.new

  tty = TTY::Logger.new output: StringIO.new do |config|
    config.handlers = [[:console, {enable_color: false}]]
  end

  message = "test"

  benchmark.config time: 5, warmup: 2

  benchmark.report("Cogger") { cogger.info message }
  benchmark.report("Dry Logger") { dry.info message }
  benchmark.report("Logging") { logging.info message }
  benchmark.report("Ougai") { ougai.info message }
  benchmark.report("TTY Logger") { tty.info message }

  benchmark.compare!
end

puts "COLOR\n\n"

Benchmark.ips do |benchmark|
  cogger = Cogger.new io: StringIO.new

  dry = Dry.Logger :demo,
                   stream: StringIO.new,
                   template: "%<severity>s %<message>s",
                   colorize: true,
                   severity_colors: {info: :green, unknown: :gray}

  Logging.color_scheme "bright",
                       levels: {
                         info: :green,
                         warn: :yellow,
                         error: :red,
                         fatal: %i[white on_red]
                       },
                       date: :blue,
                       logger: :cyan,
                       message: :magenta
  Logging.appenders.string_io "string_io",
                              layout: Logging.layouts.pattern(
                                pattern: "[%d] %-5l %c: %m\n",
                                color_scheme: "bright"
                              )
  logging = Logging.logger StringIO.new
  logging.add_appenders "string_io"

  ougai = Ougai::Logger.new StringIO.new
  ougai.formatter = Ougai::Formatters::Readable.new

  tty = TTY::Logger.new output: StringIO.new

  message = "test"

  benchmark.config time: 5, warmup: 2

  benchmark.report("Cogger") { cogger.info message }
  benchmark.report("Dry Logger") { dry.info message }
  benchmark.report("Logging") { logging.info message }
  benchmark.report("Ougai") { ougai.info message }
  benchmark.report("TTY Logger") { tty.info message }

  benchmark.compare!
end

puts "JSON\n\n"

Benchmark.ips do |benchmark|
  cogger = Cogger.new io: StringIO.new, formatter: :json
  dry = Dry.Logger :demo, stream: StringIO.new, formatter: :json

  Logging.appenders.stdout "string_io", layout: Logging.layouts.json
  logging = Logging.logger StringIO.new

  ougai = Ougai::Logger.new StringIO.new
  tty = TTY::Logger.new(output: StringIO.new) { |config| config.formatter = :json }

  payload = {one: 1, two: 2, three: 3}

  benchmark.config time: 5, warmup: 2

  benchmark.report("Cogger") { cogger.info payload }
  benchmark.report("Dry Logger") { dry.info payload }
  benchmark.report("Logging") { logging.info payload }
  benchmark.report("Ougai") { ougai.info payload }
  benchmark.report("TTY Logger") { tty.info payload }

  benchmark.compare!
end

__END__

INITIALIZATION

ruby 3.3.4 (2024-07-09 revision be1089c8ec) +YJIT [arm64-darwin23.6.0]
Warming up --------------------------------------
              Cogger    23.354k i/100ms
          Dry Logger    24.297k i/100ms
             Logging   441.541k i/100ms
               Ougai     5.564k i/100ms
          TTY Logger    21.525k i/100ms
Calculating -------------------------------------
              Cogger    219.750k (± 1.2%) i/s -      1.121M in   5.101934s
          Dry Logger    238.336k (± 1.3%) i/s -      1.215M in   5.098125s
             Logging      4.928M (± 1.6%) i/s -     24.726M in   5.018740s
               Ougai     56.268k (± 1.1%) i/s -    283.764k in   5.043753s
          TTY Logger    213.100k (± 1.3%) i/s -      1.076M in   5.051320s

Comparison:
             Logging:  4928120.2 i/s
          Dry Logger:   238335.7 i/s - 20.68x  slower
              Cogger:   219749.7 i/s - 22.43x  slower
          TTY Logger:   213100.0 i/s - 23.13x  slower
               Ougai:    56267.5 i/s - 87.58x  slower

DEFAULT

ruby 3.3.4 (2024-07-09 revision be1089c8ec) +YJIT [arm64-darwin23.6.0]
Warming up --------------------------------------
              Cogger    40.258k i/100ms
          Dry Logger    29.336k i/100ms
             Logging    35.686k i/100ms
               Ougai    42.384k i/100ms
          TTY Logger    30.050k i/100ms
Calculating -------------------------------------
              Cogger    401.632k (± 1.2%) i/s -      2.013M in   5.012588s
          Dry Logger    290.469k (± 1.6%) i/s -      1.467M in   5.051132s
             Logging    397.864k (± 5.2%) i/s -      1.998M in   5.040300s
               Ougai    481.920k (± 5.2%) i/s -      2.416M in   5.030791s
          TTY Logger    307.623k (± 4.5%) i/s -      1.563M in   5.092537s

Comparison:
               Ougai:   481920.0 i/s
              Cogger:   401631.9 i/s - 1.20x  slower
             Logging:   397863.7 i/s - 1.21x  slower
          TTY Logger:   307622.6 i/s - 1.57x  slower
          Dry Logger:   290468.8 i/s - 1.66x  slower

COLOR

ruby 3.3.4 (2024-07-09 revision be1089c8ec) +YJIT [arm64-darwin23.6.0]
Warming up --------------------------------------
              Cogger     9.617k i/100ms
          Dry Logger    27.034k i/100ms
             Logging    28.768k i/100ms
               Ougai    52.148k i/100ms
          TTY Logger    22.383k i/100ms
Calculating -------------------------------------
              Cogger     94.827k (± 1.3%) i/s -    480.850k in   5.071620s
          Dry Logger    272.332k (± 1.2%) i/s -      1.379M in   5.063431s
             Logging    288.734k (± 5.1%) i/s -      1.467M in   5.098865s
               Ougai    527.200k (± 3.4%) i/s -      2.660M in   5.051571s
          TTY Logger    225.776k (± 1.6%) i/s -      1.142M in   5.057429s

Comparison:
               Ougai:   527199.6 i/s
             Logging:   288733.8 i/s - 1.83x  slower
          Dry Logger:   272331.5 i/s - 1.94x  slower
          TTY Logger:   225776.3 i/s - 2.34x  slower
              Cogger:    94827.3 i/s - 5.56x  slower

JSON

ruby 3.3.4 (2024-07-09 revision be1089c8ec) +YJIT [arm64-darwin23.6.0]
Warming up --------------------------------------
              Cogger    22.605k i/100ms
          Dry Logger    18.516k i/100ms
             Logging    33.584k i/100ms
               Ougai    36.286k i/100ms
          TTY Logger     9.912k i/100ms
Calculating -------------------------------------
              Cogger    226.597k (± 3.4%) i/s -      1.153M in   5.094744s
          Dry Logger    187.880k (± 1.4%) i/s -    944.316k in   5.027114s
             Logging    338.638k (± 3.8%) i/s -      1.713M in   5.066779s
               Ougai    365.200k (± 5.1%) i/s -      1.851M in   5.084597s
          TTY Logger    100.089k (± 3.4%) i/s -    505.512k in   5.056332s

Comparison:
               Ougai:   365199.6 i/s
             Logging:   338637.9 i/s - same-ish: difference falls within error
              Cogger:   226596.7 i/s - 1.61x  slower
          Dry Logger:   187880.4 i/s - 1.94x  slower
          TTY Logger:   100089.0 i/s - 3.65x  slower
